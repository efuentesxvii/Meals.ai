@startuml communication-diagram
actor User
participant "Mobile/Web UI" as UI
participant "API Gateway" as API
participant "Auth Service" as Auth
participant "Meal Analysis Service" as Analysis
participant "AI Vision Provider" as Vision
participant "Nutrition Service" as Nutrition
participant "External Nutrition API" as NutAPI
participant "Recommendation Service" as Reco
database "SQL DB" as DB
participant "Object Storage" as Store

User -> UI : Upload meal photo
UI -> API : POST /meals/photo (token, image)

API -> Auth : validateToken(token)
Auth --> API : ok

API -> Store : putObject(image)
Store --> API : imageUri

API -> Analysis : submitImage(imageUri)
Analysis -> Vision : analyze(imageUri)
Vision --> Analysis : ingredients + confidence

Analysis -> Nutrition : computeNutrition(ingredients)
Nutrition -> NutAPI : lookup(ingredients)
NutAPI --> Nutrition : nutrition data
Nutrition --> Analysis : totals

API -> DB : getUserProfile(userId)
DB --> API : medical + goals

API -> Reco : generate(ingredients, totals, medical, goals)
Reco --> API : recommendations

API -> DB : saveMealLog(imageUri, totals, recos)
DB --> API : mealLogId

API --> UI : 200 OK (mealLogId, totals, recos)
UI --> User : Display results

@enduml
