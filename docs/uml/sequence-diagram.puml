@startuml sequence-diagram
skinparam style strictuml
skinparam classAttributeIconSize 0
hide empty methods

actor User
boundary "MobileApp\n<<boundary>>" as App
control "APIGateway\n<<control>>" as API
control "AuthService\n<<control>>" as Auth
control "ObjectStorage\n<<external>>" as Storage
control "MealAnalysisService\n<<control>>" as Analysis
control "VisionAIProvider\n<<external>>" as VisionAI
control "NutritionService\n<<control>>" as Nutrition
control "RecommendationService\n<<control>>" as Recommend
database "SQLDatabase\n<<entity>>" as DB

User -> App : uploadMealPhoto()
activate App

App -> API : POST /meals/photo(image, token)
activate API

API -> Auth : validateToken(token)
activate Auth

alt token invalid
  Auth --> API : invalid
  deactivate Auth

  API --> App : 401 Unauthorized
  deactivate API

  App --> User : showLoginError()
  deactivate App
else token valid
  Auth --> API : userId
  deactivate Auth

  API -> Storage : putObject(image)
  activate Storage
  Storage --> API : imageURI
  deactivate Storage

  API -> Analysis : analyzeMeal(userId, imageURI)
  activate Analysis

  Analysis -> VisionAI : detectIngredients(imageURI)
  activate VisionAI
  VisionAI --> Analysis : ingredientDetections
  deactivate VisionAI

  Analysis -> Nutrition : lookupNutrition(ingredientDetections)
  activate Nutrition
  Nutrition --> Analysis : nutritionData
  deactivate Nutrition

  Analysis -> Recommend : generateRecommendations(userId, nutritionData)
  activate Recommend
  Recommend --> Analysis : recommendations
  deactivate Recommend

  Analysis -> DB : saveMealAnalysis(userId, imageURI,\nnutritionData, recommendations)
  activate DB
  DB --> Analysis : persistOK
  deactivate DB

  Analysis --> API : analysisResultPayload
  deactivate Analysis

  API --> App : 200 OK (results)
  deactivate API

  App --> User : displayResults()
  deactivate App
end

@enduml