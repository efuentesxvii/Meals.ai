@startuml dfd-level-2-meal-analysis
left to right direction
skinparam shadowing false
skinparam linetype ortho
skinparam nodesep 180
skinparam ranksep 240

rectangle "Upstream\n3.0 Meal Capture" as Upstream
rectangle "E3 AI Vision Service" as Vision
circle "4.1\nValidate Image\n& Request" as P41
circle "4.2\nPreprocess Image\n(resize/format)" as P42
circle "4.3\nSend to Vision\nProvider" as P43
circle "4.4\nParse Vision\nResults" as P44
circle "4.5\nNormalize\nIngredients" as P45
circle "4.6\nStore Analysis\nResult" as P46

database "D4\nMeal Images\n(Object Storage)" as D4
database "D5\nAnalysis Results" as D5

rectangle "Downstream\n5.0 Nutrition\nComputation" as Downstream

Upstream --> P41 : Image URI / Metadata\nOR Manual Ingredients
P41 --> D4 : Read Image URI\n(if photo)
P41 --> P42 : Validated Image Ref

P42 --> P43 : Processed Image
P43 --> Vision : Image Payload/URI
Vision --> P44 : Raw Detections\n(items + confidence)

P44 --> P45 : Parsed Ingredients
P45 --> P46 : Normalized Ingredients\n(names/units)

P46 --> D5 : Store Ingredients\nConfidence\nTimestamps
P46 --> Downstream : Normalized Ingredients

@enduml
